# Архитектура системы авторизации

## Обзор

Система авторизации построена на основе пошагового процесса с использованием условного рендеринга и анимаций React Native Reanimated.

## Структура компонентов

### 1. AuthCarousel (`components/auth/AuthCarousel.tsx`)

**Назначение**: Контейнер для отображения шагов авторизации с плавной fade-анимацией.

**Принцип работы**:
- Рендерит только текущий активный шаг (переданный через `children`)
- При изменении `currentIndex` применяет fade-анимацию (300ms)
- Использует `react-native-reanimated` для производительных анимаций

**Props**:
- `children: React.ReactNode` - текущий шаг для отображения
- `currentIndex: number` - индекс текущего шага (используется для триггера анимации)

### 2. AuthHandler (`app/(auth)/authHandler.tsx`)

**Назначение**: Главный контроллер процесса авторизации.

**Принцип работы**:
- Использует хук `useAuthSteps()` для управления состоянием текущего шага
- Рендерит только один активный шаг с помощью функции `renderCurrentStep()`
- Оборачивает все в `PhoneProvider` для передачи данных между шагами
- Отображает индикаторы шагов с помощью `AuthBullets`

**Шаги**:
- **Step 1**: Ввод номера телефона
- **Step 2**: Подтверждение кода из SMS
- **Step 3**: Настройка профиля (username, имя, аватар)

### 3. AuthBullets (`components/auth/AuthBullets.tsx`)

**Назначение**: Визуальный индикатор текущего шага.

**Принцип работы**:
- Отображает точки по количеству шагов
- Анимирует изменение цвета активной точки (300ms)
- Использует Animated API для плавной анимации цвета

### 4. Шаги (Step1, Step2, Step3)

#### Step1 - Ввод номера телефона
- Форматирование ввода по маске `(XXX) XXX-XX-XX`
- Валидация длины номера (10 цифр)
- Сохранение номера в PhoneContext при нажатии "ПРОДОЛЖИТЬ"

#### Step2 - Проверка кода
- Ввод 5-значного кода подтверждения
- Автоматический переход на следующий шаг при правильном коде
- Таймер для повторной отправки кода (50 секунд)
- Жест свайпа вправо для возврата на предыдущий шаг
- Отображение ошибки при неверном коде

#### Step3 - Настройка профиля
- Выбор аватара
- Ввод username (минимум 4 символа)
- Ввод имени (минимум 3 символа)
- Отправка данных на сервер и получение токена
- Переход в основное приложение после успешной регистрации

## Управление состоянием

### useAuthSteps Hook (`hooks/auth/useAuthSteps.ts`)

Управляет:
- `currentStep` - индекс текущего шага
- `totalSteps` - общее количество шагов (3)
- `nextStep()` - переход на следующий шаг
- `prevStep()` - возврат на предыдущий шаг

### PhoneContext (`context/PhoneContext.tsx`)

Хранит и передает между шагами:
- `phoneNumber` - номер телефона пользователя
- `setPhoneNumber(phone: string)` - установка номера
- `confirmationCode` - код подтверждения
- `setConfirmationCode(code: string)` - установка кода

## Преимущества новой архитектуры

1. **Производительность**: Рендерится только один активный шаг, а не все сразу
2. **Простота**: Условный рендеринг проще для понимания и отладки
3. **Плавные анимации**: Использование Reanimated обеспечивает 60 FPS
4. **Изолированное состояние**: Каждый шаг управляет своим локальным состоянием
5. **Общие данные**: PhoneContext передает данные между шагами без prop drilling
6. **Масштабируемость**: Легко добавить новые шаги

## Схема потока данных

```
AuthHandler
  ├─ PhoneProvider (контекст)
  │   └─ PhoneContext { phoneNumber, confirmationCode }
  │
  ├─ useAuthSteps() (состояние шагов)
  │   └─ { currentStep, nextStep, prevStep }
  │
  ├─ AuthCarousel (анимация)
  │   └─ renderCurrentStep()
  │       ├─ Step1 → setPhoneNumber()
  │       ├─ Step2 → setConfirmationCode()
  │       └─ Step3 → отправка на сервер
  │
  └─ AuthBullets (индикатор)
```

## Возможные улучшения

1. Добавить анимацию слайда вместо fade
2. Сохранять прогресс в AsyncStorage
3. Добавить возможность пропуска шагов
4. Добавить валидацию в реальном времени
5. Добавить поддержку других стран (не только Россия)

